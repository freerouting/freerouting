name: Gemini Assistant

on:
  issue_comment:
    types: [created]

jobs:
  run_gemini_cli:
    # Check if the comment body contains the trigger phrase
    if: contains(github.event.comment.body, '@gemini-assistant')
    runs-on: ubuntu-latest
    permissions:
      issues: write  # Allows the action to write comments
      pull-requests: write # Allows the action to write comments
    steps:
      # Step 1: Run the Gemini CLI and get its output
      - name: Run Gemini CLI
        id: gemini_call # Give this step an ID to reference its output
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          
          # Pass the prompt as before
          prompt: |
            You are a helpful assistant for the Freerouting project.
            The user's comment is below. Respond to it in the context of the issue.
            User comment: "${{ github.event.comment.body }}"         

      # Step 2: Use a separate action to post the output from Step 1
      - name: Post response as issue comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get the output text from the previous step (which we named 'gemini_call')
            const output = `${{ steps.gemini_call.outputs.gemini-response }}`;
            
            // Use the GitHub API to create a new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });